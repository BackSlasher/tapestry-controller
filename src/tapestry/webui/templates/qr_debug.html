{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bug"></i> QR Code Debug Tool
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Upload an image containing QR codes to see detection results with bounding boxes overlaid.
                </p>

                <form id="debug-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="debug-image" class="form-label">Select Image</label>
                        <input type="file" class="form-control" id="debug-image" name="image" accept="image/*" required>
                        <div class="form-text">
                            Supported formats: PNG, JPG, GIF, BMP, TIFF<br>
                            Max size: 16MB
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="analyze-btn">
                            <i class="bi bi-search"></i> Analyze QR Codes
                        </button>
                    </div>
                </form>

                <div id="loading" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Analyzing...</span>
                    </div>
                    <p class="mt-2">Analyzing image...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Debug Information</h6>
            </div>
            <div class="card-body">
                <div id="debug-info">
                    <p class="text-muted">Upload an image to see debug information here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Debug Visualization</h6>
            </div>
            <div class="card-body">
                <div id="debug-image-container" class="text-center">
                    <p class="text-muted">Debug visualization will appear here after analysis.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('debug-form');
    const analyzeBtn = document.getElementById('analyze-btn');
    const loading = document.getElementById('loading');
    const debugInfo = document.getElementById('debug-info');
    const debugImageContainer = document.getElementById('debug-image-container');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const file = formData.get('image');

        if (!file || file.size === 0) {
            alert('Please select an image file.');
            return;
        }

        // Show loading state
        analyzeBtn.disabled = true;
        loading.style.display = 'block';
        debugInfo.innerHTML = '<p class="text-muted">Analyzing...</p>';
        debugImageContainer.innerHTML = '<p class="text-muted">Processing...</p>';

        try {
            const response = await fetch('/qr-debug/analyze', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                displayResults(data);
            } else {
                showError(data.error || 'Analysis failed');
            }
        } catch (error) {
            console.error('Analysis error:', error);
            showError('Failed to analyze image: ' + error.message);
        } finally {
            // Reset loading state
            analyzeBtn.disabled = false;
            loading.style.display = 'none';
        }
    });

    function displayResults(data) {
        // Display debug info
        let infoHtml = `
            <div class="alert alert-success">
                <strong>Analysis Complete!</strong><br>
                Found ${data.total_found} QR code(s)
            </div>
        `;

        if (data.qr_codes.length > 0) {
            infoHtml += '<h6>Detected QR Codes:</h6>';
            infoHtml += '<div class="list-group list-group-flush">';

            data.qr_codes.forEach(qr => {
                infoHtml += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">QR Code ${qr.id}</h6>
                            <small>Rotation: ${qr.rotation.toFixed(1)}°</small>
                        </div>
                        <p class="mb-1"><strong>Host:</strong> ${escapeHtml(qr.hostname)}</p>
                        <p class="mb-1"><strong>Screen Type:</strong> ${escapeHtml(qr.screen_type)}</p>
                        <small class="text-muted">
                            Center: (${qr.center[0].toFixed(1)}, ${qr.center[1].toFixed(1)})<br>
                            Bbox: (${qr.bbox.x.toFixed(0)}, ${qr.bbox.y.toFixed(0)}) ${qr.bbox.width.toFixed(0)}×${qr.bbox.height.toFixed(0)}
                        </small>
                    </div>
                `;
            });

            infoHtml += '</div>';
        } else {
            infoHtml += '<div class="alert alert-warning">No QR codes detected in the image.</div>';
        }

        debugInfo.innerHTML = infoHtml;

        // Display debug image
        if (data.debug_image) {
            debugImageContainer.innerHTML = `
                <img src="${data.debug_image}" class="img-fluid border" alt="Debug visualization">
                <p class="mt-2 text-muted">
                    <small>Red boxes show detected QR code bounding boxes</small>
                </p>
            `;
        } else {
            debugImageContainer.innerHTML = '<p class="text-muted">No debug image available.</p>';
        }
    }

    function showError(message) {
        debugInfo.innerHTML = `
            <div class="alert alert-danger">
                <strong>Error:</strong> ${escapeHtml(message)}
            </div>
        `;
        debugImageContainer.innerHTML = '<p class="text-muted">Analysis failed.</p>';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %}